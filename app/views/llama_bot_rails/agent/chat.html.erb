<!DOCTYPE html>
<html>
<head>
  <title>LlamaBot Chat</title>
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --accent-color: #2196f3;
      --error-color: #f44336;
      --success-color: #4caf50;
      --sidebar-width: 250px;
      --sidebar-collapsed-width: 60px;
      --header-height: 80px;
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
      overflow: hidden;  /* Prevent content from causing horizontal scroll */
    }

    .threads-sidebar {
      width: var(--sidebar-width);
      background-color: var(--bg-secondary);
      padding: 20px;
      border-right: 1px solid #404040;
      overflow-y: auto;
      transition: width 0.3s ease;
      position: relative;
      flex-shrink: 0;  /* Prevent sidebar from shrinking */
      min-width: var(--sidebar-width);  /* Ensure minimum width */
    }

    .threads-sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
      min-width: var(--sidebar-collapsed-width);  /* Update min-width when collapsed */
      padding: 20px 10px;
    }

    .threads-sidebar.collapsed .thread-item {
      display: none;
    }

    .threads-sidebar.collapsed h2 {
      display: none;
    }

    .thread-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .thread-item:hover {
      background-color: #404040;
    }

    .thread-item.active {
      background-color: var(--accent-color);
    }

    .chat-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      transition: margin-left 0.3s ease;
      min-width: 0;  /* Allow container to shrink below its content size */
      overflow: hidden;  /* Prevent content from causing horizontal scroll */
    }

    .chat-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      height: var(--header-height);
    }

    .logo {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .toggle-sidebar {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      padding: 8px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }

    .toggle-sidebar:hover {
      background-color: var(--bg-secondary);
      border-radius: 4px;
    }

    .toggle-sidebar.collapsed {
      transform: rotate(180deg);
    }

    .chat-messages {
      flex-grow: 1;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      margin-bottom: 20px;
      background-color: var(--bg-secondary);
    }

    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user-message {
      background-color: var(--accent-color);
      margin-left: auto;
    }

    .bot-message {
      background-color: #404040;
      margin-right: auto;
    }

    .error-message {
      background-color: var(--error-color);
      color: white;
      margin-right: auto;
      border-left: 4px solid #d32f2f;
    }

    .pong-message {
      text-align: center;
      font-size: 24px;
      color: #e91e63;
      margin: 10px 0;
    }

    .input-container {
      display: flex;
      gap: 10px;
      padding: 10px 0;
    }

    #message-input {
      flex-grow: 1;
      padding: 12px;
      border: 1px solid #404040;
      border-radius: 4px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    button {
      padding: 12px 24px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #1976d2;
    }

    @media (max-width: 768px) {
      .threads-sidebar {
        position: fixed;
        height: 100vh;
        z-index: 1000;
        transform: translateX(0);
        transition: transform 0.3s ease;
      }

      .threads-sidebar.collapsed {
        transform: translateX(-100%);
        width: var(--sidebar-width);
      }

      .chat-container {
        margin-left: 0;
      }

      .message {
        max-width: 90%;
      }
    }
  </style>
  <%= javascript_include_tag "llama_bot_rails/application" %>
  <%= action_cable_meta_tag %>
</head>
<body>
  <div class="app-container">
    <div class="threads-sidebar" id="threads-sidebar">
      <h2>Conversations</h2>
      <div id="threads-list">
        <!-- Threads will be added here dynamically -->
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <button class="toggle-sidebar" id="toggle-sidebar" title="Toggle sidebar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        <img src="https://service-jobs-images.s3.us-east-2.amazonaws.com/7rl98t1weu387r43il97h6ipk1l7" alt="LlamaBot Logo" class="logo">
        <h1>LlamaBot Chat</h1>
      </div>
      <div class="chat-messages" id="chat-messages">
        <!-- Messages will be added here dynamically -->
      </div>
      <div class="input-container">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    let currentThreadId = null;
    let isSidebarCollapsed = false;

    // Initialize ActionCable connection
    const consumer = LlamaBotRails.cable;
    const subscription = consumer.subscriptions.create('LlamaBotRails::ChatChannel', {
      connected() {
        console.log('Connected to chat channel');
        loadThreads();
      },
      disconnected() {
        console.log('Disconnected from chat channel');
      },
      received(data) {
        const parsedData = JSON.parse(data).message;
        switch(parsedData.type) {
          case "ai":
            addMessage(parsedData.content, 'bot');
            break;
          case "error":
            addMessage(parsedData.content, 'error');
            break;
          case "pong":
            addMessage('❤️', 'pong');
            break;
        }
      }
    });

    // Toggle sidebar
    document.getElementById('toggle-sidebar').addEventListener('click', function() {
      const sidebar = document.getElementById('threads-sidebar');
      const toggleButton = this;
      isSidebarCollapsed = !isSidebarCollapsed;
      
      sidebar.classList.toggle('collapsed');
      toggleButton.classList.toggle('collapsed');
    });

    async function loadThreads() {
      try {
        const response = await fetch('/llama_bot/agent/threads');
        const threads = await response.json();
        console.log('Loaded threads:', threads);  // Debug log
        
        const threadsList = document.getElementById('threads-list');
        threadsList.innerHTML = '';
        
        if (!threads || threads.length === 0) {
          console.log('No threads available');
          // Create a default thread
          const defaultThread = {
            thread_id: 'global_thread_id',
            title: 'New Conversation'
          };
          const threadElement = createThreadElement(defaultThread);
          threadsList.appendChild(threadElement);
          loadThread(defaultThread.thread_id);  // Automatically load the default thread
          return;
        }
        
        threads.forEach(thread => {
          const threadElement = createThreadElement(thread);
          threadsList.appendChild(threadElement);
        });

        // Load the first thread by default
        if (threads.length > 0) {
          const firstThreadId = threads[0].thread_id || threads[0].id;
          loadThread(firstThreadId);
        }
      } catch (error) {
        console.error('Error loading threads:', error);
        // Create a default thread on error
        const defaultThread = {
          thread_id: 'global_thread_id',
          title: 'New Conversation'
        };
        const threadElement = createThreadElement(defaultThread);
        document.getElementById('threads-list').appendChild(threadElement);
        loadThread(defaultThread.thread_id);
      }
    }

    function createThreadElement(thread) {
      const threadElement = document.createElement('div');
      threadElement.className = 'thread-item';
      const threadId = thread.thread_id || thread.id;
      threadElement.textContent = threadId;
      threadElement.dataset.threadId = threadId;
      threadElement.onclick = () => {
        console.log('Clicked thread with ID:', threadId);  // Debug log
        loadThread(threadId);
      };
      return threadElement;
    }

    async function loadThread(threadId) {
      console.log('Loading thread:', threadId);  // Debug log
      
      if (!threadId) {
        console.error('No thread ID provided');
        return;
      }
      
      currentThreadId = threadId;
      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML = '';

      try {
        const response = await fetch(`/llama_bot/agent/chat-history/${threadId}`);
        const threadState = await response.json();
        console.log('Loaded thread state:', threadState);  // Debug log
        
        if (Array.isArray(threadState) && threadState.length > 0) {
          // Get the messages array from the first state object
          const messages = threadState[0].messages || [];
          console.log('Processing messages:', messages);  // Debug log
          
          messages.forEach(message => {
            if (message && message.content) {
              addMessage(message.content, message.type === 'human' ? 'user' : 'bot');
            }
          });
        }

        // Update active thread in sidebar
        document.querySelectorAll('.thread-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.threadId === threadId) {
            item.classList.add('active');
          }
        });
      } catch (error) {
        console.error('Error loading chat history:', error);
        addMessage('Error loading chat history', 'error');
      }
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (message) {
        addMessage(message, 'user');
        input.value = '';

        const messageData = {
          message: message,
          thread_id: currentThreadId || 'global_thread_id'
        };
        
        console.log('Sending message with data:', messageData);  // Debug log
        subscription.send(messageData);
      }
    }

    function addMessage(text, sender) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;
      messageDiv.textContent = text;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('message-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html> 